use Collection;

class JsonStreamParser {
	@parse_stack : Stack<Pair<IntRef, Base>>;
	@document : Char[];
	@is_debug : Bool;

	enum Type {
		OBJECT,
		ARRAY,
		NUMBER,
		NULL
	}

	function : Main(args : String[]) ~ Nil {
		parser := JsonStreamParser->New(System.IO.Filesystem.FileReader->ReadFile(args[0]));
		success := parser->GetMatch("Luke");
		"Success? {$success}."->PrintLine();
	}

	New(document : String) {
		@document := document->ToCharArray();
		@is_debug := true;
		@parse_stack := Stack->New()<Pair<IntRef, Base>>;
	}

	# TODO: get
	method : public : native : GetNextMatch(key : String) ~ Bool {
		return false; # TODO: return an object
	}

	method : public : native : GetNextMatch(index : Int) ~ Bool {
		return false; # TODO: return an object
	}

	# 1 pass parsing; 
	# while element searching; 
	# if the element is found;
	# parsing stops; 
	# lazy @documentument is done
	method : public : native : GetMatch(key : String) ~ Bool {
		# TODO: return an object
		
		each(char_pos : @document) {
			char := @document[char_pos];

			# white space
			while(char->IsWhitespace()) {
				char := @document[++char_pos]
			}

			# TODO: "true", "false"

			# true
			if(char = 't') {
				char := @document[++char_pos]
				if(char <> 'r') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'u') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'e') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				if(@is_debug) {
					stack_size := @parse_stack->Size();
					"TRUE => level={$stack_size}"->PrintLine();
				}
			}
			# false
			else if(char = 'f') {
				char := @document[++char_pos]
				if(char <> 'a') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'l') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 's') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'e') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				if(@is_debug) {
					stack_size := @parse_stack->Size();
					"FALSE => level={$stack_size}"->PrintLine();
				}
			}
			# null
			else if(char = 'n') {
				char := @document[++char_pos]
				if(char <> 'u') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'l') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				char := @document[++char_pos]
				if(char <> 'l') {
					"\texpected: null"->ErrorLine();
					return false;
				}

				if(@is_debug) {
					stack_size := @parse_stack->Size();
					"NULL => level={$stack_size}"->PrintLine();
				}
			}
			# number
			else if(char->IsDigit()) {
				start_pos := char_pos;
				while(char->IsDigit()) {
					char := @document[++char_pos]
				}

				if(@is_debug) {
					stack_size := @parse_stack->Size();
					num := String->New(@document, start_pos, char_pos - start_pos);
					"NUMBER => level={$stack_size}, value={$num}"->PrintLine();
				}
			}
			else {
				select(char) {
					# string
					label '"' {
						char := @document[++char_pos]
						start_pos := char_pos;
						while(char->IsChar()) {
							char := @document[++char_pos]
						}

						if(char <> '"') {
							"\texpected: '\""->ErrorLine();
							return false;
						}

						value := String->New(@document, start_pos, char_pos - start_pos);
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"STRING => level={$stack_size}, value='{$value}'"->PrintLine();
						}

						if(key->Equals(value)) {
							"*** Found at pos={$char_pos} ***"->PrintLine();
							return true;
						}
					}

					label '{' {
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"OBJ_ST => level={$stack_size}"->PrintLine();
						}
						@parse_stack->Push(Pair->New(IntRef->New(Type->OBJECT), Nil)<IntRef, Base>);
					}

					label '}' {
						type := @parse_stack->Pop()<Pair<IntRef, Base>>;
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"OBJ_ED => level={$stack_size}"->PrintLine();
						}

						if(type = Nil | type->GetFirst()->Get() <> Type->OBJECT) {
							"\texpected: '}'"->ErrorLine();
							return false;
						}
					}

					label '[' {
						if(@is_debug) {
						stack_size := @parse_stack->Size();
							"ARY_ST => level={$stack_size}"->PrintLine();
						}
						@parse_stack->Push(Pair->New(IntRef->New(Type->ARRAY), Nil)<IntRef, Base>);						
					}

					label ']' {
						type := @parse_stack->Pop()<Pair<IntRef, Base>>;
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"ARY_ED => level={$stack_size}"->PrintLine();
						}

						if(type = Nil | type->GetFirst()->Get() <> Type->ARRAY) {
							"\texpected: ']'"->ErrorLine();
							return false;
						}
					}

					label ':' {
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"COLON => level={$stack_size}"->PrintLine();
						}
					}

					label ',' {
						if(@is_debug) {
							stack_size := @parse_stack->Size();
							"COMMA => level={$stack_size}"->PrintLine();
						}
					}

					other {
						if(char <> ':' | char <> ',') {
							stack_size := @parse_stack->Size();
							"\tunexpected token => level={$stack_size}, value='{$char}'"->ErrorLine();
							return false;
						}
					}
				}
			}
		}

		if(<>@parse_stack->IsEmpty()) {
			"\texpected: '}' or ']'"->ErrorLine();
			return false;
		}

		return true;
	}
}