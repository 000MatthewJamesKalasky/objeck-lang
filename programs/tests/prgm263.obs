use Web.HTTP, Collection;

class Test {
	function : Main(args : String[]) ~ Nil {
		m1 := [
			[1., 4.0]
			[1., 4.5]
			[1., 5.0]
			[1., 5.5]
			[1., 6.0]
			[1., 6.5]
			[1., 7.0]];

		m2 := [
			[33.]
			[42.]
			[45.]
			[51.]
			[53.]
			[61.]
			[62.]];

#~
		# linear regression

		m1 := [
			[1., 1.]
			[1., 2.]
			[1., 3.]
			[1., 4.]
			[1., 5.]];
			
		m2 := [
			[2.]
			[4.]
			[5.]
			[4.]
			[5.]];
~#
		coeff := GetCoefficients(m1, m2);
		coeff->ToString()->PrintLine();
		GetRSquared(coeff, m1, m2)->PrintLine();
	}

	function : GetRSquared(c : Float[,], m1 : Float[,], m2 : Float[,]) ~ Float {
		avg := System.ML.Matrix2D->AverageColumn(0, m2);

		m_dim := m2->Size();
		m_rows := m_dim[0];

		dom := 0.;
		each(i : m_rows) {
			term := m2[i,0] - avg;
			dom += term * term;
		};

		c_dim := c->Size();
		c_rows := c_dim[0];

		num := 0.;
		each(i : m_rows) {
			equ_sum := 0.0;

			# TODO: replace 1 with cols (i.e. n+1 from offset)
			each(j : c_rows) {
				if(j = 0) {
					equ_sum := c[j,0];
				}
				else {
					equ_sum += c[j,0] * m1[i,1]; # replace 1 with offset
				};
			};

			term := equ_sum - avg;
			num += term * term;
		};

		return num/dom;
	}

	function : TotalVar(m : Float[,], m_mean : Float) ~ Float {
		m_dim := m->Size();
		m_rows := m_dim[0];

		m_sum := 0.0;

		each(i : m_rows) {
			term := m[i,0] - m_mean;
			m_sum += term * term;
		}

		return m_sum;
	}


	function : GetStdDev(col : Int, m : Float[,]) ~ Float {
		m_dim := m->Size();
		m_rows := m_dim[0];

		total_sum := 0.0;
		each(i : m_rows) {
			total_sum += m[i,0];
		};
		m_avg := total_sum / m_rows->Size()->As(Float);

		total_sum := 0.0;
		each(i : m_rows) {
			term := m[i,0] - m_avg;
			total_sum += term * term;
		};

		return Float->Sqrt(total_sum / (m_rows->As(Float) - 1.));
	}

	function : GetCoefficients(m1 : Float[,], m2 : Float[,]) ~ Float[,] {
		m1_trans := System.ML.Matrix2D->Transpose(m1);
		lhs_coeffs := System.ML.Matrix2D->Inverse(System.ML.Matrix2D->DotProduct(m1_trans, m1));
		rhs_coeffs := System.ML.Matrix2D->DotProduct(m1_trans, m2);
		
		return System.ML.Matrix2D->DotProduct(lhs_coeffs, rhs_coeffs);
	}
}