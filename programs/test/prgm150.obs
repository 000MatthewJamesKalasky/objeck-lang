use Collection.Generic;

class Test {
	function : Main(args : String[]) ~ Nil {
		a := "aaa";
		b := "bbb";
		c := "ccc";

		lru := LruCache->New(2);

		

		lru->Add("a", a);
		lru->Add("a", a);
		lru->Add("a", a);
		lru->Add("a", a);

		lru->Add("b", b);
		lru->Add("b", b);

		lru->Add("c", c);
		lru->Add("c", c);
		lru->Add("c", c);
		lru->Add("c", c);
		lru->Add("c", c);

		lru->Add("a", a);
		lru->Add("b", b);

		lru->Size()->PrintLine();

		pairs := lru->GetKeyValues();
		each(i : pairs) {
			pair := pairs->Get(i)<Compare, Base>;
			pair->GetFirst()->As(String)->PrintLine();
		};
	}
}

class LruCache {
	@max : Int;
	@cache : Map<Compare, Base>;
	@priority : CompareList<Compare>;

	New(max : Int) {
		@max := max;
		@cache := Map->New()<Compare, Base>;
		@priority := CompareList->New()<Compare>;
	}

	method : public : Add(key : Compare, value : Base) ~ Bool {
		if(@priority->Size() < @max) {
			if(@cache->Has(key)) {
				@priority->Find(key);
				@priority->Remove();
				@priority->AddFront(key);
			}
			else {
				@cache->Insert(key, value);
				@priority->AddFront(key);
			};

			return true;
		}
		else {
			RemoveLast();
			Add(key, value);
		};

		return false;
	}

	method : public : Remove(key : Compare) ~ Bool {
		if(@cache->Has(key)) {
			@priority->Find(key);
			@priority->Remove();
			@cache->Remove(key);

			return true;
		};

		return false;
	}

	method : RemoveLast() ~ Bool {
		if(<>@priority->IsEmpty()) {
			last := @priority->Back();
			@priority->RemoveBack();
			@cache->Remove(last);

			return true;
		};

		return false;
	}

	method : public : GetKeys() ~ Vector<Compare> {
		return @cache->GetKeys()<Compare>;
	}

	method : public : GetValues() ~ Vector<Base> {
		return @cache->GetValues()<Base>;
	}

	method : public : GetKeyValues() ~ Vector<Pair<Compare, Base>> {
		return @cache->GetKeyValues()<Pair<Compare, Base>>;
	}

	method : public : Find(key : Compare) ~ Base {
		return @cache->Find(key);
	}

	method : public : Has(key : Compare) ~ Bool {
		return @cache->Find(key) <> Nil;
	}

	method : public : Size() ~ Int {
		return @cache->Size();
	}

	method : public : IsEmpty() ~ Bool {
		return @cache->IsEmpty();
	}
}
