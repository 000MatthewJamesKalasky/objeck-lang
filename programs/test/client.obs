use Collection;
use System.IO;
use System.IO.File;
use System.IO.Net;

class Client {
	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 1) {
			values := StringMap->New();
			values->Insert("name", "Objeck");
			values->Insert("age", IntHolder->New(10));

			serializer := Serializer->New();
			serializer->Write(values);
			bytes := serializer->Serialize();

			if(args[0]->Equals("socket")) {
				WriteSocket(bytes);
			}
			else {
				WriteFile(bytes);
			};
		};
	}

	function : WriteFile(bytes : Byte[]) ~ Nil {
		bytes := Byte->Compress(bytes);
bytes->Size()->PrintLine();		
		
		file := FileWriter->New("D:/Code/objeck-lang/programs/test/data.dat");
		leaving {
			file->Close();
		};
		
		file->WriteBuffer(bytes);
	}

	function : WriteSocket(bytes : Byte[]) ~ Nil {
		client := TCPSocket->New("localhost", 4660);
		leaving {
			client->Flush();
			client->Close();
		};

		if(client->IsOpen()) {
			size := bytes->Size();
			size_str := size->ToString();
			client->WriteString(size_str);
			client->WriteBuffer(0, size, bytes)->PrintLine();
		};
	}	
}