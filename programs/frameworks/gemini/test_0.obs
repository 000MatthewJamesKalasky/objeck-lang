use Web.HTTP, Collection, Data.JSON;

class Test {
	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 2) {
			token := args[0];
			question := args[1];

			request := MakeRequest(question);
			url := Url->New("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={$token}&a=b");
url->GetQueryParameters()->Find("key")->PrintLine();
#~			
			response := DoRequest(request, url, token);
			if(response <> Nil) {
				content := ParseResponse(response);
				each(line in content) {
					line->PrintLine();
				};
			};
~#			
		};		
	}

	function : MakeRequest(text : String) ~ JsonElement {
		part_array_json := JsonElement->New(JsonElement->JsonType->OBJECT);
		part_array_json->Insert("text", text);

		# ---

		parts_array_json := JsonElement->New(JsonElement->JsonType->ARRAY);
		parts_array_json->Add(part_array_json);

		parts_json := JsonElement->New(JsonElement->JsonType->OBJECT);
		parts_json->Insert("parts", parts_array_json);

		# ---

		contents_array_json := JsonElement->New(JsonElement->JsonType->ARRAY);
		contents_array_json->Add(parts_json);

		contents_json := JsonElement->New(JsonElement->JsonType->OBJECT);
		contents_json->Insert("contents", contents_array_json);

		return contents_json;
	}

	function : ParseResponse(response : JsonElement) ~ Vector<String> {
		responses := Vector->New()<String>;

		candidates_json := response->Get("candidates");
		if(candidates_json <> Nil & candidates_json->Size() > 0) {
			content_json := candidates_json->Get(0)->Get("content");
			parts_json := content_json->Get("parts");
			if(parts_json <> Nil & parts_json->Size() > 0) {
				text_json := parts_json->Get(0)->Get("text");
				role_json := content_json->Get("role");

				responses->AddBack(role_json->GetString());
				responses->AddBack(JsonElement->Decode(text_json->GetString()));
			};
		};

		return responses;
	}

	function : DoRequest(request : JsonElement, url : String, token : String) ~ JsonElement {
		response := HttpsClient->QuickPost(Url->New(url), request->ToString()->ToByteArray(), "application/json");
		if(response <> Nil) {
			response_json := JsonParser->TextToElement(response->GetContent()->ToString());
			# response->GetContent()->ToString()->PrintLine();			
			if(response_json = Nil) {
				"### Error: Unable to parse response ###"->ErrorLine();
				return Nil;
			};
			
			if(response_json->Has("error")) {
response_json->ToString()->PrintLine();				
				"### Error: Error response ###"->ErrorLine();
				return Nil;
			};

			return response_json;
		};

		return Nil;
	}
}