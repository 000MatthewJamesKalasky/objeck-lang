use Web.HTTP, Collection, System.IO.Filesystem, Data.JSON, Web.HTTP.Server;

bundle API.OpenAI {
	class Test {
		function : Main(args : String[]) ~ Nil {
			if(args->Size() = 2) {
				# file := args[0];
				token := args[1];

				file := API.OpenAI.File->New("file-ZfOj8q7RASApmJTNGVd6oRMi", token);
				file->GetId()->PrintLine();

				assistant := Assistant->New("gpt-3.5-turbo-0125", "DU Basketball", "DU Basketball", "You are historian in the University of Denver Men's basketball", token);
				assistant->AddFile(file);
#				assistant->AddTool("retrieval");
				assistant->Create()->PrintLine();

#~
				# Files->Upload(file, FileReader->ReadBinaryFile(file), token)->PrintLine();
				files := Files->List(token);
				each(file in files) {
					file->ToString()->PrintLine();
				};

				file := File->New("file-ZfOj8q7RASApmJTNGVd6oRMi", token);
				file->ToString()->PrintLine();
				file->Retrieve()->ToString()->PrintLine();
~#				
			};
		}

		function : GetStringValue(name : String, element : JsonElement) ~ String {
			value := "";

			value_json := element->Get(name);
			if(value_json <> Nil & <>value_json->IsNull()) {
				value := value_json->GetString();
			};

			return value;
		}

		function : DebugRequest(boundry : String) ~ Byte[] {
			boundry->Append("--------------------------OH8iaaTMuIlMnbNRt76GZo");
			cr_lf := "\r\n";
			
			buffer := "--{$boundry}{$cr_lf}";
			buffer += "Content-Disposition: form-data; name=\"purpose\"{$cr_lf}";
			buffer += "{$cr_lf}";
			buffer += "assistants{$cr_lf}";
			buffer += "--{$boundry}{$cr_lf}";
			buffer += "Content-Disposition: form-data; name=\"file\"; filename=\"bar.json\"{$cr_lf}";
			buffer += "Content-Type: application/octet-stream{$cr_lf}";
			buffer += "{$cr_lf}";
			buffer += "{ \"value\": 17 }{$cr_lf}";
			buffer += "--{$boundry}--";

			return buffer->ToByteArray();
		}
	}

	# TODO: Okay
	class File {
		@token : String;

		@id : String;
		@object : String;
		@bytes : Int;
		@created_at : Int;
		@filename : String;
		@purpose : String;

		New(file_json : JsonElement, token : String) {
			@token := token;

			@id := file_json->Get("id")->GetString();
			@object := file_json->Get("object")->GetString();
			@bytes := file_json->Get("bytes")->GetInt();
			@created_at := file_json->Get("created_at")->GetInt();
			@filename := file_json->Get("filename")->GetString();
			@purpose := file_json->Get("purpose")->GetString();
		}

		New(id : String, token : String) {
			@token := token;

			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$@token}");
			response := HttpsClient->QuickGet(Url->New("https://api.openai.com/v1/files/{$id}"), "application/json", headers);
			if(response <> Nil) {
				file_json := JsonParser->TextToElement(response->GetContent()->ToString());

				if(file_json = Nil | file_json->Has("error")) {
					error_str := file_json->FindElements("error/message")->GetString();
					"### Error: {$error_str} ###"->ErrorLine();
				}
				else {
					@id := file_json->Get("id")->GetString();
					@object := file_json->Get("object")->GetString();
					@bytes := file_json->Get("bytes")->GetInt();
					@created_at := file_json->Get("created_at")->GetInt();
					@filename := file_json->Get("filename")->GetString();
					@purpose := file_json->Get("purpose")->GetString();
				};
			};
		}

		method : public : Retrieve() ~ Byte[] {
			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$@token}");
			return HttpsClient->QuickGet(Url->New("https://api.openai.com/v1/files/{$@id}/content"), "application/json", headers)->GetContent();
		}

		method : public : GetId() ~ String {
			return @id;
		}

		method : public : GetObject() ~ String {
			return @object;
		}

		method : public : GetBytes() ~ Int {
			return @bytes;
		}

		method : public : GetCreatedAt() ~ Int {
			return @created_at;
		}

		method : public : GetFilename() ~ String {
			return @filename;
		}

		method : public : GetPurpose() ~ String {
			return @purpose;
		}

		method : public : ToString() ~ String {
			return "[id='{$@id}', object='{$@object}', bytes={$@bytes}, created_at={$@created_at}, filename='{$@filename}', purpose='{$@purpose}'']"; 
		}
	}

	# TODO: Okay
	class Files {
		function : List(token : String) ~ Vector<API.OpenAI.File> {
			files := Vector->New()<API.OpenAI.File>

			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$token}");
			response := HttpsClient->QuickGet(Url->New("https://api.openai.com/v1/files"), "application/json", headers);
			if(response <> Nil) {
				root_json := JsonParser->TextToElement(response->GetContent()->ToString());

				if(root_json = Nil) {
					return Nil;
				};

				if(root_json->Has("error")) {
					error_str := root_json->FindElements("error/message")->GetString();
					"### Error: {$error_str} ###"->ErrorLine();
					return Nil;
				};

				files_json := root_json->Get("data");
				each(file_json in files_json) {
					files->AddBack(API.OpenAI.File->New(file_json, token));
				};
			};

			return files;
		}

		function : Upload(name : String, content : Byte[], token : String) ~ Bool {
			purpose_headers := Map->New()<String, String>;
			purpose_headers->Insert("Content-Disposition", "form-data; name=\"purpose\"");
			purpose_content := MultipartContent->New(purpose_headers, "assistants"->ToByteArray());

			content_headers := Map->New()<String, String>;
			content_headers->Insert("Content-Disposition", "form-data; name=\"file\"; filename=\"{$name}\"");
			content_headers->Insert("Content-Type", "application/octet-stream");
			multi_content := MultipartContent->New(content_headers, content);

			encoder := MultipartEncoder->New();
			encoder->Add(purpose_content);
			encoder->Add(multi_content);
			boundry := encoder->GetBoundary();
			data := encoder->ToByteArray();

			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$token}");
			headers->Insert("Content-Type", "multipart/form-data; boundary={$boundry}");
			response := HttpsClient->QuickPost(Url->New("https://api.openai.com/v1/files"), data, "multipart/form-data", headers);			
			return response->GetCode() = 200;
		}
	}

	# TODO: not okay fix up
	class Assistant {
		@token : String;

		@id : String;
		@object : String;
		@model : String;
		@name : String;
		@description : String;
		@instructions : String;
		@created_at : Int;
		@metadata : Map<String, String>;

		@tools : Vector<String>;
		@files : Vector<File>;

		New(model : String, token : String) {
			@model := model;
			@token := token;

			@tools := Vector->New()<String>;
			@files := Vector->New()<File>;
			@metadata := Map->New()<String, String>;
		}

		New(model : String, name : String, token : String) {
			@model := model;
			@name := name;
			@token := token;

			@tools := Vector->New()<String>;
			@files := Vector->New()<File>;
			@metadata := Map->New()<String, String>;
		}

		New(model : String, name : String, description : String, instructions : String, token : String) {
			@model := model;
			@name := name;
			@description := description;
			@instructions := instructions;
			@token := token;
			
			@tools := Vector->New()<String>;
			@files := Vector->New()<File>;
			@metadata := Map->New()<String, String>;
		}

		method : public : SetName(name : String) ~ Nil {
			@name := name;
		}

		method : public : SetDescription(description : String) ~ Nil {
			@description := description;
		}

		method : public : SetInstructions(instructions : String) ~ Nil {
			@instructions := instructions;
		}

		method : public : AddFile(file : File) ~ Nil {
			@files->AddBack(file);
		}

		method : public : AddTool(tool : String) ~ Nil {
			@tools->AddBack(tool);
		}

		method : public : AddMetadata(key : String, value : String) ~ Nil {
			@metadata->Insert(key, value);
		}

		method : public : Create() ~ Bool {
			if(@model = Nil) {
				return false;
			};

			builder := JsonBuilder->New();
			create_json := builder->PushObject();
			create_json->Insert("model", @model);

			if(@name <> Nil) {
				create_json->Insert("name", @name);
			};

			if(@description <> Nil) {
				create_json->Insert("description", @description);
			};

			if(@instructions <> Nil) {
				create_json->Insert("instructions", @instructions);
			};

			# tools
			if(<>@tools->IsEmpty()) {
				tools_json := JsonElement->New(JsonElement->JsonType->ARRAY);
				each(tool in @tools) {
					tool_json := JsonElement->New(JsonElement->JsonType->OBJECT);
					tool_json->Insert("type", tool);
					tools_json->Add(tool_json);
				};
				create_json->Insert("tools", tools_json);
			};

			# files
			if(<>@files->IsEmpty()) {
				files_json := JsonElement->New(JsonElement->JsonType->ARRAY);
				each(file in @files) {
					files_json->Add(file->GetId());
				};
				create_json->Insert("file_ids", files_json);
			};

#~
			# metadata
			if(<>@metadata->IsEmpty()) {
				metadatas_json := JsonElement->New(JsonElement->JsonType->ARRAY);
				keys_values := @metadata->GetKeyValues()<Pair<String, String>>;
				each(key_value in keys_values) {
					key := key_value->GetFirst();
					value := key_value->GetSecond();

					metadata_json := JsonElement->New(JsonElement->JsonType->OBJECT);
					metadata_json->Insert(key, value);
					metadatas_json->Add(metadata_json);
				};
				create_json->Insert("metadata", metadatas_json);
			};
~#
			
			data := builder->PopAll()->ToString()->ToByteArray();
			# data->ToString()->PrintLine();			

			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$@token}");
			headers->Insert("OpenAI-Beta", "assistants=v1");
			response := HttpsClient->QuickPost(Url->New("https://api.openai.com/v1/assistants"), data, "application/json", headers);
			if(response <> Nil) {
response->GetContent()->ToString()->PrintLine();				
				assistant_json := JsonParser->TextToElement(response->GetContent()->ToString());
				if(assistant_json = Nil) {
					return false;
				};
				
				if(assistant_json->Has("error")) {
					error_str := assistant_json->FindElements("error/message")->GetString();
					"### Error: {$error_str} ###"->ErrorLine();
					return false;
				}

				@id := assistant_json->Get("id")->GetString();
				@created_at := assistant_json->Get("created_at")->GetInt();
				@object := assistant_json->Get("object")->GetString();
				@name := assistant_json->Get("name")->GetString();
				@description := assistant_json->Get("description")->GetString();
				@model := assistant_json->Get("model")->GetString();
				@instructions := assistant_json->Get("instructions")->GetString();

				return true;
			};

			return false;
		}

		method : public : ToString() ~ String {
			buffer := "";

			return buffer;
		}
	}
}