use Web.HTTP, Collection, System.IO.Filesystem, Data.JSON;

class Test {
	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 1) {
			key := args[0];
			
			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$key}");

			data := "
				{
					\"model\": \"gpt-3.5-turbo\",
					\"messages\": [
						{
							\"role\": \"system\",
							\"content\": \"You are a calculator\"
						},
						{
							\"role\": \"user\",
							\"content\": \"evaluate (((3 + 7) * 3) - 17)\"
						}
					]
				}
			";

			response_doc := HttpsClient->QuickPost(
				Url->New("https://api.openai.com/v1/chat/completions"), 
				data, "application/json", headers);

			if(response_doc <> Nil) {
				response_json := JsonParser->TextToElement(response_doc->ToString());
				if(response_json <> Nil) {
					choices_json := response_json->Get("choices");
					each(choice_json in choices_json) {
						content_str := choice_json->FindElements("message/content");
						answer := JsonElement->Decode(content_str->GetString());
answer->PrintLine();						
					};
				};
			};
		};
	}
}