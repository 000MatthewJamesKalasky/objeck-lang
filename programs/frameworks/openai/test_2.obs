use Web.HTTP, Collection, System.IO.Filesystem, Data.JSON;

class Test {
	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 1) {
			key := args[0];
			
			headers := Map->New()<String, String>;
			headers->Insert("Authorization", "Bearer sk-{$key}");

			data := "
				{
					\"model\": \"gpt-3.5-turbo\",
					\"messages\": [
						{
							\"role\": \"system\",
							\"content\": \"You are a helpful assistant.\"
						},
						{
							\"role\": \"user\",
							\"content\": \"Add 13 + 7 as JSON\"
						}
					]
				}
			";

			response := HttpsClient->QuickPost(
				Url->New("https://api.openai.com/v1/chat/completions"), 
				data, "application/json", headers);

			if(response <> Nil) {
# response->ToString()->PrintLine();
				response_json := JsonParser->TextToElement(response->ToString());
				choices_json := response_json->Get("choices");
				each(choice_json in choices_json) {
					content_str := choice_json->FindElements("message/content");
					JsonElement->Decode(content_str->GetString())->PrintLine();
				};
			};
		};
	}
}