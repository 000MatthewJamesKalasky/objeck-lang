use Collection.Generic;
use System.IO.File;
use Data.CSV;

class CsvData {
	@table : Query.Structured.Table;
	@attached_file_out : FileWriter;

	function : Main(args : String[]) ~ Nil {
		if(args->Size() = 1) {
			CsvData->New()->Process(args[0]);
		}
		else {
			"Invalid arguments!"->ErrorLine();
		};
	}

	New() {
		@attached_file_out := FileWriter->New(".\\onboarding.csv");
	}

	method : public : Process(file : String) ~ Nil {
		leaving {
			if(@attached_file_out <> Nil) {
				@attached_file_out->Close();
			};
		};

		@table := Query.Structured.Table->FromCsv("sales", file);
		if(@table <> Nil) {
			Calulate("All", Select(RegionType->ALL));
			Calulate("Enterprise", Select(RegionType->ENTERPRISE));
			Calulate("Strategic", Select(RegionType->STRATEGIC));
		};
	}

	method : Select(type : RegionType) ~ Query.Structured.Table {
		select(type) {
			label RegionType->ALL {
				return @table->Query("select distinct Contract from sales 
					where ('Business Type' = 'New Logo' or 'Business Type' = 'New Division/Department') 
					and ('Product Name' like '%Coverity%' or 'Product Name' like '%Duck Pro%')");
			}

			label RegionType->VELOCITY {

			}

			label RegionType->ENTERPRISE {
				return @table->Query("select distinct Contract from sales 
					where ('Business Type' = 'New Logo' or 'Business Type' = 'New Division/Department') 
					and ('Product Name' like '%Coverity%' or 'Product Name' like '%Duck Pro%') 
					and ('Region' like '%East%' or 'Region' like '%West%')");

			}
			label RegionType->STRATEGIC {
				return @table->Query("select distinct Contract from sales 
					where ('Business Type' = 'New Logo' or 'Business Type' = 'New Division/Department') 
					and ('Product Name' like '%Coverity%' or 'Product Name' like '%Duck Pro%') 
					and ('Region' = 'Strategic')");
			}
		};

		return Nil;
	}

	method : Calulate(title : String, results : Query.Structured.Table) ~ Nil {
		if(results <> Nil) {
			num_contracts := results->Size();
			bronze_count := silver_count := gold_count := platinum_count := 0;
			each(i : results) {
				contract := results->Get(i)->row->Get(1)->As(String);
				contracts := @table->Query("from sales where Contract = '{$contract}'");
				found := false;
				for(j := 0; <>found & j < contracts->Size(); j += 1;) {
					product_name := contracts->Get(j)->Get("Product Name")->As(String);
					if(<>found) {
						if(product_name->Has("Platinum")) {
							platinum_count++;
							found := true;
						}
						else if(product_name->Has("Gold")) {
							gold_count++;
							found := true;
						}
						else if(product_name->Has("Silver")) {
							silver_count++;
							found := true;
						}
						else if(product_name->Has("Bronze")) {
							bronze_count++;
							found := true;
						};
					};
				};
			};

			"[{$title}]"->PrintLine();
			percent : Int := bronze_count = 0 ? 0.0 : 100.0 * bronze_count->As(Float) / num_contracts->As(Float);
			"Bronze={$bronze_count}, {$percent}%"->PrintLine();
			attach_total_percent += percent;

			percent := silver_count = 0 ? 0.0 : 100.0 * silver_count->As(Float) / num_contracts->As(Float);
			"Silver={$silver_count}, {$percent}%"->PrintLine();
			attach_total_percent += percent;
			
			percent := gold_count = 0 ? 0.0 : 100.0 * gold_count->As(Float) / num_contracts->As(Float);
			"Gold={$gold_count}, {$percent}%"->PrintLine();
			attach_total_percent += percent;

			percent := platinum_count = 0 ? 0.0 : 100.0 * platinum_count->As(Float) / num_contracts->As(Float);
			"Platinum={$platinum_count}, {$percent}%"->PrintLine();
			attach_total_percent += percent;

			"---"->PrintLine();
			"sample={$num_contracts}, {$attach_total_percent}%\n"->PrintLine();

			WriteAttached(title, bronze_count, silver_count, gold_count, platinum_count, num_contracts);
		}
		else {
			"Invalid query?"->ErrorLine();
		};
	}

	method : WriteAttached(title : String, bronze_count : Int, silver_count : Int, gold_count : Int, platinum_count : Int, num_contracts : Int) ~ Nil {		
		none := num_contracts - bronze_count - gold_count - silver_count - platinum_count;
		@attached_file_out->WriteString("{$title}\r\n");
		@attached_file_out->WriteString("Package,Count,\r\n");
		@attached_file_out->WriteString("Bronze,{$bronze_count}\r\n");
		@attached_file_out->WriteString("Silver,{$silver_count}\r\n");
		@attached_file_out->WriteString("Gold,{$gold_count}\r\n");
		@attached_file_out->WriteString("Platinum,{$platinum_count}\r\n");
		@attached_file_out->WriteString("None,{$none}\r\n");
	}

	enum RegionType {
		ALL,
		VELOCITY,
		ENTERPRISE,
		STRATEGIC
	}
}